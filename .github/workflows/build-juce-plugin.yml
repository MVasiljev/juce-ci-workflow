# Reusable workflow for building JUCE audio plugins
# Usage from other repos:
#   jobs:
#     build:
#       uses: MVasiljev/juce-ci-workflow/.github/workflows/build-juce-plugin.yml@main
#       with:
#         plugin_name: "My Plugin"
#         version: "1.0.0"
#       secrets: inherit

name: Build JUCE Plugin

on:
  workflow_call:
    inputs:
      plugin_name:
        description: 'Name of the plugin (e.g., "Niviem Phase II")'
        required: true
        type: string
      version:
        description: 'Version string (e.g., "1.0.0")'
        required: true
        type: string
      juce_version:
        description: 'JUCE version to use'
        required: false
        type: string
        default: '8.0.4'
      build_au:
        description: 'Build Audio Unit (macOS only)'
        required: false
        type: boolean
        default: true
      build_vst3:
        description: 'Build VST3'
        required: false
        type: boolean
        default: true
    secrets:
      APPLE_CERT_BASE64:
        required: false
      APPLE_CERT_PASSWORD:
        required: false
      APPLE_ID:
        required: false
      APPLE_ID_PASSWORD:
        required: false
      APPLE_TEAM_ID:
        required: false

jobs:
  build-macos:
    name: macOS (AU + VST3)
    runs-on: macos-latest
    steps:
      - name: Checkout plugin repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup JUCE
        run: |
          if [ ! -d "JUCE" ]; then
            git clone --depth 1 --branch ${{ inputs.juce_version }} https://github.com/juce-framework/JUCE.git ../JUCE
          fi

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Check for signing certificate
        id: check_cert
        env:
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
        run: |
          if [ -n "$APPLE_CERT_BASE64" ]; then
            echo "HAS_SIGNING_CERT=true" >> $GITHUB_ENV
            echo "Certificate found, will sign and notarize"
          else
            echo "HAS_SIGNING_CERT=false" >> $GITHUB_ENV
            echo "No certificate found, skipping signing"
          fi

      - name: Import Code Signing Certificate
        if: ${{ env.HAS_SIGNING_CERT == 'true' }}
        env:
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Decode certificate
          echo "$APPLE_CERT_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12

          # Create and configure keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERT_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Allow codesign to access the key
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          echo "Certificate imported successfully"

      - name: Code Sign Plugins
        if: ${{ env.HAS_SIGNING_CERT == 'true' }}
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Find and sign all plugins
          IDENTITY="Developer ID Application: Milan Vasiljev ($APPLE_TEAM_ID)"

          # Sign AU
          AU_PATH=$(find build -name "*.component" -type d | head -1)
          if [ -n "$AU_PATH" ]; then
            codesign --force -s "$IDENTITY" -v "$AU_PATH" --deep --strict --options=runtime --timestamp
            echo "Signed AU: $AU_PATH"
          fi

          # Sign VST3
          VST3_PATH=$(find build -name "*.vst3" -type d | head -1)
          if [ -n "$VST3_PATH" ]; then
            codesign --force -s "$IDENTITY" -v "$VST3_PATH" --deep --strict --options=runtime --timestamp
            echo "Signed VST3: $VST3_PATH"
          fi

      - name: Notarize Plugins
        if: ${{ env.HAS_SIGNING_CERT == 'true' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create zip for notarization
          mkdir -p notarize_temp

          AU_PATH=$(find build -name "*.component" -type d | head -1)
          VST3_PATH=$(find build -name "*.vst3" -type d | head -1)

          [ -n "$AU_PATH" ] && cp -R "$AU_PATH" notarize_temp/
          [ -n "$VST3_PATH" ] && cp -R "$VST3_PATH" notarize_temp/

          ditto -c -k --keepParent notarize_temp notarize.zip

          # Submit for notarization
          xcrun notarytool submit notarize.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple notarization
          [ -n "$AU_PATH" ] && xcrun stapler staple "$AU_PATH"
          [ -n "$VST3_PATH" ] && xcrun stapler staple "$VST3_PATH"

          echo "Notarization complete!"

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/macos

          # Find and copy AU
          if [ "${{ inputs.build_au }}" = "true" ]; then
            find build -name "*.component" -type d | head -1 | xargs -I {} cp -R {} artifacts/macos/
          fi

          # Find and copy VST3
          if [ "${{ inputs.build_vst3 }}" = "true" ]; then
            find build -name "*.vst3" -type d | head -1 | xargs -I {} cp -R {} artifacts/macos/
          fi

          ls -la artifacts/macos/

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.plugin_name }}-v${{ inputs.version }}-macOS
          path: artifacts/macos/

  build-windows:
    name: Windows (VST3)
    runs-on: windows-latest
    steps:
      - name: Checkout plugin repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup JUCE
        run: |
          if (!(Test-Path "JUCE")) {
            git clone --depth 1 --branch ${{ inputs.juce_version }} https://github.com/juce-framework/JUCE.git ../JUCE
          }

      - name: Configure CMake
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Prepare artifacts
        shell: bash
        run: |
          mkdir -p artifacts/windows
          find build -name "*.vst3" -type d | head -1 | xargs -I {} cp -R {} artifacts/windows/
          ls -la artifacts/windows/

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.plugin_name }}-v${{ inputs.version }}-Windows
          path: artifacts/windows/

  create-release-bundle:
    name: Create Release Bundle
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Create combined bundle
        run: |
          mkdir -p release

          # Copy each platform's artifacts (macOS + Windows only)
          cp -R all-artifacts/*-macOS/* release/ 2>/dev/null || true
          cp -R all-artifacts/*-Windows/* release/ 2>/dev/null || true

          # Create final ZIP
          cd release
          zip -r "../${{ inputs.plugin_name }}_v${{ inputs.version }}_All_Platforms.zip" .

          ls -la ../

      - name: Upload combined bundle
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.plugin_name }}-v${{ inputs.version }}-ALL-PLATFORMS
          path: ${{ inputs.plugin_name }}_v${{ inputs.version }}_All_Platforms.zip
